name: Release Relayer

on:
  workflow_dispatch:
    inputs:
      runtime_version:
        description: 'Runtime version number (e.g. v2.0.7)'
        required: true
        type: string
      runtime:
        description: 'Select runtime to release'
        required: true
        type: choice
        options:
          - 'BridgeHubPolkadot'
          - 'BridgeHubKusama'
        default: 'BridgeHubKusama'
  push:
    branches: ["rs-manual-release-ci-workflow"]

permissions:
  contents: write
  pull-requests: write

jobs:
  release:
    runs-on: ubuntu-latest
    outputs:
      RUNTIME_VERSION: ${{ steps.parse-versions.outputs.RUNTIME_VERSION }}
      RELAYER_VERSION: ${{ steps.bump-version.outputs.RELAYER_VERSION }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Create wbuild directory
        run: mkdir -p ./tools/runtime-codegen/wbuild

      - name: Install prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          rustup component add --toolchain nightly-x86_64-unknown-linux-gnu rustfmt

      - name: Parse versions
        id: parse-versions
        env:
          RUNTIME_VERSION: ${{ github.event.inputs.runtime_version }}
        run: |
          runtime_num="${RUNTIME_VERSION#v}"
          IFS='.' read -ra VERSION_PARTS <<< "$runtime_num"
          major="${VERSION_PARTS[0]}"
          minor="${VERSION_PARTS[1]}" 
          patch="${VERSION_PARTS[2]}"
          # Add leading zeros
          minor=$(printf "%03d" "$minor")
          patch=$(printf "%03d" "$patch")
          
          # Convert runtime version to release version (e.g., v2.0.7 -> v2000007)
          release_version="v$major$minor$patch"
          
          # Convert runtime version to spec version (e.g., v2.0.7 -> 2_000_007)
          spec_version="${major}_${minor}_${patch}"
          
          echo "Runtime version: $RUNTIME_VERSION"
          echo "Release version: $release_version"
          echo "Spec version: $spec_version"

          # Save runtime version for use in subsequent steps
          echo "RUNTIME_VERSION=$runtime_version" >> $GITHUB_ENV
          echo "RELEASE_VERSION=$release_version" >> $GITHUB_ENV
          echo "SPEC_VERSION=$spec_version" >> $GITHUB_ENV
          echo "RUNTIME_VERSION=$runtime_version" >> $GITHUB_OUTPUT

      - name: Download runtime files
        env:
          RUNTIME_VERSION: ${{ env.RUNTIME_VERSION }}
          RELEASE_VERSION: ${{ env.RELEASE_VERSION }}
          RUNTIME_NAME: ${{ github.event.inputs.runtime }}
        run: |
          # Load runtime matrix and set environment variables based on selection

          # Extract runtime configuration from matrix
          runtime_config=$(jq ".[] | select(.name == \"$RUNTIME_NAME\")" .github/runtime-matrix.json)
          
          # Set environment variables with interpolated values
          runtime_uri=$(echo "$runtime_config" | jq -r '.runtime_uri' | sed "s/\${runtime_version}/$RUNTIME_VERSION/g" | sed "s/\${release_version}/$RELEASE_VERSION/g")
          runtime_file=$(echo "$runtime_config" | jq -r '.runtime_file' | sed "s/\${runtime_version}/$RUNTIME_VERSION/g" | sed "s/\${release_version}/$RELEASE_VERSION/g")
          target_dir=$(echo "$runtime_config" | jq -r '.target_dir')
          target_librs="$target_dir/lib.rs"
          
          # Export environment variables
          echo "RUNTIME_FILE=$runtime_file" >> $GITHUB_ENV
          echo "TARGET_DIR=$target_dir" >> $GITHUB_ENV
          echo "TARGET_LIBRS=$target_librs" >> $GITHUB_ENV
          
          echo "Downloading runtime for $RUNTIME_NAME..."
          echo "Runtime URI: $runtime_uri"
          echo "Runtime File: $runtime_file"
          echo "Target Directory: $target_dir"
          echo "Target Lib RS: $target_librs"
          
          # Download runtime
          wget -O "./tools/runtime-codegen/$runtime_file" "$runtime_uri"
          
          # Check if file was downloaded successfully
          if [[ ! -f "./tools/runtime-codegen/$runtime_file" ]]; then
            echo "Error: Failed to download runtime file: $runtime_file"
            echo "Aborting workflow."
            exit 1
          fi
          
          echo "Successfully downloaded: $runtime_file"
          ls -lh "./tools/runtime-codegen/$runtime_file"

      - name: Update spec version in client files
        env:
          SPEC_VERSION: ${{ env.SPEC_VERSION }}
          TARGET_LIBRS: ${{ env.TARGET_LIBRS }}
        run: |
          echo "Spec version: $SPEC_VERSION"
          echo "Target librs: $TARGET_LIBRS"
          echo "Current content:"
          grep "spec_version:" "$TARGET_LIBRS" || echo "No spec_version found"
          sed -i "s/spec_version: [0-9_]*/spec_version: $SPEC_VERSION/" "$TARGET_LIBRS"
          echo "Updated content:"
          grep "spec_version:" "$TARGET_LIBRS"

      - name: Run runtime codegen
        env:
          RUNTIME_FILE: ${{ env.RUNTIME_FILE }}
          TARGET_DIR: ${{ env.TARGET_DIR }}
        run: |
          # Extract runtime filename from RUNTIME_FILE
          runtime_filename=$(basename "$RUNTIME_FILE")
          
          echo "Running runtime codegen for $runtime_filename"
          cd ./tools/runtime-codegen && cargo run --bin runtime-codegen --release -- --from-wasm-file "$RUNTIME_FILE" | tee "../../$TARGET_DIR/codegen_runtime.rs"

      - name: Bump minor version in Cargo.toml
        id: bump-version
        run: |
          # Get current version and bump minor version
          current_version=$(grep '^version = ' substrate-relay/Cargo.toml | cut -d'"' -f2)
          major=$(echo "$current_version" | cut -d. -f1)
          minor=$(echo "$current_version" | cut -d. -f2)
          patch=$(echo "$current_version" | cut -d. -f3)
          
          # Increment patch version
          new_patch=$((patch + 1))
          new_version="$major.$minor.$new_patch"
          echo "RELAYER_VERSION=$new_version" >> $GITHUB_OUTPUT
          
          echo "Bumping relayer version from $current_version to $new_version"
          sed -i "s/version = \"$current_version\"/version = \"$new_version\"/" substrate-relay/Cargo.toml

      - name: Fix Header generic types & Format code
        run: |
          cargo +nightly fmt --all
          find . -name codegen_runtime.rs -exec \
            sed -i 's/::sp_runtime::generic::Header<::core::primitive::u32>/::sp_runtime::generic::Header<::core::primitive::u32, ::sp_runtime::traits::BlakeTwo256>/g' {} +
          cargo +nightly fmt --all

          echo "Cargo check"
          SKIP_WASM_BUILD=1 cargo check --locked --workspace

          echo "Cargo clippy"
          SKIP_WASM_BUILD=1 cargo clippy --locked --workspace --all-targets --all-features

      - name: Create Pull Request
        env:
          RUNTIME_NAME: ${{ github.event.inputs.runtime }}
          RUNTIME_VERSION: ${{ env.RUNTIME_VERSION }}
          RELAYER_VERSION: ${{ env.RELAYER_VERSION }}
          SPEC_VERSION: ${{ env.SPEC_VERSION }}
        uses: peter-evans/create-pull-request@v8
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          base: master
          commit-message: |
            Update runtime: $RUNTIME_NAME $RUNTIME_VERSION
            
            - Update spec version to $SPEC_VERSION
            - Bump substrate-relay version to $RELAYER_VERSION
            - Regenerate runtime code
          title: "Update runtime: $RUNTIME_NAME $RUNTIME_VERSION"
          body: |
            Automated runtime update:
            
            - Runtime: $RUNTIME_NAME
            - Spec Version: $SPEC_VERSION
            
            Changes:
            - Updated spec version in client files
            - Bumped substrate-relay minor version
            - Regenerated runtime code
            - Applied formatting fixes
          branch: "runtime-update-$RUNTIME_NAME-$RUNTIME_VERSION"
          delete-branch: true
          add-paths: |
            relay-clients/**/codegen_runtime.rs
            relay-clients/**/lib.rs
            substrate-relay/Cargo.toml
            Cargo.lock

  create-tag:
    runs-on: ubuntu-latest
    needs: release
    if: github.event_name == 'pull_request' && github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: master
          base-owner: paritytech

      - name: Create and push tag
        env:
          RUNTIME_VERSION: ${{ needs.release.outputs.RUNTIME_VERSION }}
          RELAYER_VERSION: ${{ needs.release.outputs.RELAYER_VERSION }}
        run: |
          tag_name="v$RELAYER_VERSION"
          
          echo "Creating tag: $tag_name"
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git tag -a "$tag_name" -m "Release $tag_name - Runtime: $RUNTIME_VERSION - Substrate-relay: $RELAYER_VERSION"
          
          git push origin "$tag_name"
