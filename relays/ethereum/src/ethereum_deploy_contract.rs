// Copyright 2019-2020 Parity Technologies (UK) Ltd.
// This file is part of Parity Bridges Common.

// Parity Bridges Common is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.

// Parity Bridges Common is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with Parity Bridges Common.  If not, see <http://www.gnu.org/licenses/>.

use crate::ethereum_client;
use crate::ethereum_types::U256;
use crate::substrate_client;
use crate::substrate_types::{Hash as SubstrateHash, Header as SubstrateHeader};
use codec::{Decode, Encode};
use num_traits::Zero;
use parity_crypto::publickey::KeyPair;

/// Ethereum synchronization parameters.
#[derive(Debug)]
pub struct EthereumDeployContractParams {
	/// Ethereum RPC host.
	pub eth_host: String,
	/// Ethereum RPC port.
	pub eth_port: u16,
	/// Ethereum chain id.
	pub eth_chain_id: u64,
	/// Ethereum transactions signer.
	pub eth_signer: KeyPair,
	/// Gas price we agree to pay.
	pub eth_gas_price: U256,
	/// Ethereum contract bytecode.
	pub eth_contract_code: Vec<u8>,
	/// Substrate RPC host.
	pub sub_host: String,
	/// Substrate RPC port.
	pub sub_port: u16,
	/// Initial authorities set id.
	pub sub_initial_authorities_set_id: Option<u64>,
	/// Initial authorities set.
	pub sub_initial_authorities_set: Option<Vec<u8>>,
	/// Initial header.
	pub sub_initial_header: Option<Vec<u8>>,
}

impl Default for EthereumDeployContractParams {
	fn default() -> Self {
		EthereumDeployContractParams {
			eth_host: "localhost".into(),
			eth_port: 8545,
			eth_chain_id: 0x11, // Parity dev chain
			// that the account that has a lot of ether when we run instant seal engine
			// address: 0x00a329c0648769a73afac7f9381e08fb43dbea72
			// secret: 0x4d5db4107d237df6a3d58ee5f70ae63d73d7658d4026f2eefd2f204c81682cb7
			eth_signer: KeyPair::from_secret_slice(
				&hex::decode("4d5db4107d237df6a3d58ee5f70ae63d73d7658d4026f2eefd2f204c81682cb7")
					.expect("secret is hardcoded, thus valid; qed"),
			).expect("secret is hardcoded, thus valid; qed"),
			eth_gas_price: 8_000_000_000u64.into(), // 8 Gwei
			eth_contract_code: hex::decode("60806040523480156200001157600080fd5b50604051620012e2380380620012e2833981810160405260608110156200003757600080fd5b81019080805160405193929190846401000000008211156200005857600080fd5b838201915060208201858111156200006f57600080fd5b82518660018202830111640100000000821117156200008d57600080fd5b8083526020830192505050908051906020019080838360005b83811015620000c3578082015181840152602081019050620000a6565b50505050905090810190601f168015620000f15780820380516001836020036101000a031916815260200191505b5060405260200180519060200190929190805160405193929190846401000000008211156200011f57600080fd5b838201915060208201858111156200013657600080fd5b82518660018202830111640100000000821117156200015457600080fd5b8083526020830192505050908051906020019080838360005b838110156200018a5780820151818401526020810190506200016d565b50505050905090810190601f168015620001b85780820380516001836020036101000a031916815260200191505b50604052505050620001c96200044d565b620001d362000471565b620001e66000866200025a60201b60201c565b915091506000620001fd836200039260201b60201c565b90508060018190555084600360000160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555083600360010190805190602001906200024d9291906200048e565b505050505050506200053d565b620002646200044d565b6200026e62000471565b60405180606001604052806000801b815260200185856040516020018083815260200180602001828103825283818151815260200191508051906020019080838360005b83811015620002cf578082015181840152602081019050620002b2565b50505050905090810190601f168015620002fd5780820380516001836020036101000a031916815260200191505b50935050505060405160208183030381529060405280519060200120604051602001808281526020019150506040516020818303038152906040528152602001856040516020018082815260200191505060405160208183030381529060405281525060405180604001604052806000801b815260200160405180602001604052806000815250815250915091509250929050565b6000808260200151805190602001209050600060025490506000801b8114620003d1578160056000838152602001908152602001600020600001819055505b83600560008481526020019081526020016000206000820151816000015560208201518160010190805190602001906200040d9291906200048e565b5060408201518160020190805190602001906200042c9291906200048e565b50905050816002819055506001600054016000819055508192505050919050565b60405180606001604052806000801916815260200160608152602001606081525090565b604051806040016040528060008019168152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620004d157805160ff191683800117855562000502565b8280016001018555821562000502579182015b8281111562000501578251825591602001919060010190620004e4565b5b50905062000511919062000515565b5090565b6200053a91905b80821115620005365760008160009055506001016200051c565b5090565b90565b610d95806200054d6000396000f3fe608060405234801561001057600080fd5b50600436106100455760003560e01c80635fb234d31461004b578063bf3a82371461019d578063d96a2deb1461027057610046565b5b600080fd5b61019b6004803603604081101561006157600080fd5b810190808035906020019064010000000081111561007e57600080fd5b82018360208201111561009057600080fd5b803590602001918460018302840111640100000000831117156100b257600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f8201169050808301925050505050505091929192908035906020019064010000000081111561011557600080fd5b82018360208201111561012757600080fd5b8035906020019184600183028401116401000000008311171561014957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f82011690508083019250505050505050919291929050505061035f565b005b610256600480360360208110156101b357600080fd5b81019080803590602001906401000000008111156101d057600080fd5b8201836020820111156101e257600080fd5b8035906020019184600183028401116401000000008311171561020457600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610704565b604051808215151515815260200191505060405180910390f35b610278610742565b604051808060200180602001838103835285818151815260200191508051906020019080838360005b838110156102bc5780820151818401526020810190506102a1565b50505050905090810190601f1680156102e95780820380516001836020036101000a031916815260200191505b50838103825284818151815260200191508051906020019080838360005b83811015610322578082015181840152602081019050610307565b50505050905090810190601f16801561034f5780820380516001836020036101000a031916815260200191505b5094505050505060405180910390f35b6000806104d5600360000160009054906101000a900467ffffffffffffffff1660036001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104185780601f106103ed57610100808354040283529160200191610418565b820191906000526020600020905b8154815290600101906020018083116103fb57829003601f168201915b50505050506005600060025481526020019081526020016000206001018054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156104c95780601f1061049e576101008083540402835291602001916104c9565b820191906000526020600020905b8154815290600101906020018083116104ac57829003601f168201915b505050505087876108a7565b91509150600080905060008390505b828110156106c1576104f4610bd6565b6104fc610bfa565b61050683896108c1565b9150915060008260400151805190602001209050610523836109f2565b5060008260200151511461053b5761053a82610aa8565b5b6060600660008381526020019081526020016000208054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156105e45780601f106105b9576101008083540402835291602001916105e4565b820191906000526020600020905b8154815290600101906020018083116105c757829003601f168201915b5050505050905060008151146106b257851561064b576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526038815260200180610d286038913960400191505060405180910390fd5b600195506001600360000160009054906101000a900467ffffffffffffffff1601600360000160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555080600360010190805190602001906106b0929190610c17565b505b505050508060010190506104e4565b5061040060005411156106fd57600061040060005403905060008090505b818110156106fa576106ef610b5f565b8060010190506106df565b50505b5050505050565b600080600560008480519060200120815260200190815260200160002060010180546001816001161561010002031660029004905014159050919050565b606080600060056000600254815260200190815260200160002090508060020181600101818054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156107fb5780601f106107d0576101008083540402835291602001916107fb565b820191906000526020600020905b8154815290600101906020018083116107de57829003601f168201915b50505050509150808054600181600116156101000203166002900480601f0160208091040260200160405190810160405280929190818152602001828054600181600116156101000203166002900480156108975780601f1061086c57610100808354040283529160200191610897565b820191906000526020600020905b81548152906001019060200180831161087a57829003601f168201915b5050505050905092509250509091565b600080600080819150809050915091509550959350505050565b6108c9610bd6565b6108d1610bfa565b60405180606001604052806000801b815260200185856040516020018083815260200180602001828103825283818151815260200191508051906020019080838360005b83811015610930578082015181840152602081019050610915565b50505050905090810190601f16801561095d5780820380516001836020036101000a031916815260200191505b50935050505060405160208183030381529060405280519060200120604051602001808281526020019150506040516020818303038152906040528152602001856040516020018082815260200191505060405160208183030381529060405281525060405180604001604052806000801b815260200160405180602001604052806000815250815250915091509250929050565b6000808260200151805190602001209050600060025490506000801b8114610a30578160056000838152602001908152602001600020600001819055505b8360056000848152602001908152602001600020600082015181600001556020820151816001019080519060200190610a6a929190610c17565b506040820151816002019080519060200190610a87929190610c17565b50905050816002819055506001600054016000819055508192505050919050565b6000600660008360000151815260200190815260200160002080546001816001161561010002031660029004905014610b2c576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526023815260200180610d056023913960400191505060405180910390fd5b806020015160066000836000015181526020019081526020016000209080519060200190610b5b929190610c17565b5050565b600060015490506000600560008381526020019081526020016000209050806000015460018190555060056000838152602001908152602001600020600080820160009055600182016000610bb49190610c97565b600282016000610bc49190610c97565b50506001600054036000819055505050565b60405180606001604052806000801916815260200160608152602001606081525090565b604051806040016040528060008019168152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10610c5857805160ff1916838001178555610c86565b82800160010185558215610c86579182015b82811115610c85578251825591602001919060010190610c6a565b5b509050610c939190610cdf565b5090565b50805460018160011615610100020316600290046000825580601f10610cbd5750610cdc565b601f016020900490600052602060002090810190610cdb9190610cdf565b5b50565b610d0191905b80821115610cfd576000816000905550600101610ce5565b5090565b9056fe4475706c6963617465207369676e616c20666f72207468652073616d6520626c6f636b547279696e6720746f20656e616374207365766572616c2073657473207573696e672073696e676c652066696e616c6974792070726f6f66a26469706673582212201dfa6c78befea4189891d2753946bda7e7033a5300d644d6ada1f098ea3a315464736f6c63430006050033")
				.expect("code is hardcoded, thus valid; qed"),
			sub_host: "localhost".into(),
			sub_port: 9933,
			sub_initial_authorities_set_id: None,
			sub_initial_authorities_set: None,
			sub_initial_header: None,
		}
	}
}

/// Deploy Bridge contract on Ethereum chain.
pub fn run(params: EthereumDeployContractParams) {
	let mut local_pool = futures::executor::LocalPool::new();

	let result = local_pool.run_until(async move {
		let eth_uri = format!("http://{}:{}", params.eth_host, params.eth_port);
		let eth_client = ethereum_client::client(&eth_uri);

		let sub_uri = format!("http://{}:{}", params.sub_host, params.sub_port);
		let sub_client = substrate_client::client(&sub_uri);

		let (sub_client, initial_header) = prepare_initial_header(sub_client, params.sub_initial_header).await;
		let (initial_header_hash, initial_header) = initial_header?;

		let initial_set_id = params.sub_initial_authorities_set_id.unwrap_or(0);
		let (_, initial_set) = prepare_initial_authorities_set(
			sub_client,
			initial_header_hash,
			params.sub_initial_authorities_set,
		).await;
		let initial_set = initial_set?;

		ethereum_client::deploy_bridge_contract(
			eth_client,
			params.eth_signer,
			params.eth_chain_id,
			params.eth_gas_price,
			params.eth_contract_code,
			initial_header.encode(),
			initial_set_id,
			initial_set,
		).await.1.map_err(|error| format!("Error deploying contract: {:?}", error))
	});

	if let Err(error) = result {
		log::error!(target: "bridge", "{}", error);
	}
}

/// Prepare initial header.
async fn prepare_initial_header(
	sub_client: substrate_client::Client,
	sub_initial_header: Option<Vec<u8>>,
) -> (substrate_client::Client, Result<(SubstrateHash, Vec<u8>), String>) {
	match sub_initial_header {
		Some(raw_initial_header) => {
			match SubstrateHeader::decode(&mut &raw_initial_header[..]) {
				Ok(initial_header) => (sub_client, Ok((initial_header.hash(), raw_initial_header))),
				Err(error) => (sub_client, Err(format!("Error decoding initial header: {}", error))),
			}
		},
		None => {
			let (sub_client, initial_header) = substrate_client::header_by_number(
				sub_client,
				Zero::zero(),
			).await;
			(
				sub_client,
				initial_header
					.map(|header| (header.hash(), header.encode()))
					.map_err(|error| format!("Error reading Substrate genesis header: {:?}", error))
			)
		},
	}
}

/// Prepare initial GRANDPA authorities set.
async fn prepare_initial_authorities_set(
	sub_client: substrate_client::Client,
	sub_initial_header_hash: SubstrateHash,
	sub_initial_authorities_set: Option<Vec<u8>>,
) -> (substrate_client::Client, Result<Vec<u8>, String>) {
	let (sub_client, initial_authorities_set) = match sub_initial_authorities_set {
		Some(initial_authorities_set) => (sub_client, Ok(initial_authorities_set)),
		None => substrate_client::grandpa_authorities_set(
			sub_client,
			sub_initial_header_hash,
		).await,
	};

	(
		sub_client,
		initial_authorities_set
			.map_err(|error| format!("Error reading GRANDPA authorities set: {:?}", error)),
	)
}
