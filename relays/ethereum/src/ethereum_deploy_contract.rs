// Copyright 2019-2020 Parity Technologies (UK) Ltd.
// This file is part of Parity Bridges Common.

// Parity Bridges Common is free software: you can redistribute it and/or modify
// it under the terms of the GNU General Public License as published by
// the Free Software Foundation, either version 3 of the License, or
// (at your option) any later version.

// Parity Bridges Common is distributed in the hope that it will be useful,
// but WITHOUT ANY WARRANTY; without even the implied warranty of
// MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
// GNU General Public License for more details.

// You should have received a copy of the GNU General Public License
// along with Parity Bridges Common.  If not, see <http://www.gnu.org/licenses/>.

use crate::ethereum_client;
use crate::ethereum_types::U256;
use crate::substrate_client;
use crate::substrate_types::{Hash as SubstrateHash, Header as SubstrateHeader};
use codec::{Decode, Encode};
use num_traits::Zero;
use parity_crypto::publickey::KeyPair;

/// Ethereum synchronization parameters.
#[derive(Debug)]
pub struct EthereumDeployContractParams {
	/// Ethereum RPC host.
	pub eth_host: String,
	/// Ethereum RPC port.
	pub eth_port: u16,
	/// Ethereum chain id.
	pub eth_chain_id: u64,
	/// Ethereum transactions signer.
	pub eth_signer: KeyPair,
	/// Gas price we agree to pay.
	pub eth_gas_price: U256,
	/// Ethereum contract bytecode.
	pub eth_contract_code: Vec<u8>,
	/// Substrate RPC host.
	pub sub_host: String,
	/// Substrate RPC port.
	pub sub_port: u16,
	/// Initial authorities set id.
	pub sub_initial_authorities_set_id: Option<u64>,
	/// Initial authorities set.
	pub sub_initial_authorities_set: Option<Vec<u8>>,
	/// Initial header.
	pub sub_initial_header: Option<Vec<u8>>,
}

impl Default for EthereumDeployContractParams {
	fn default() -> Self {
		EthereumDeployContractParams {
			eth_host: "localhost".into(),
			eth_port: 8545,
			eth_chain_id: 0x11, // Parity dev chain
			// that the account that has a lot of ether when we run instant seal engine
			// address: 0x00a329c0648769a73afac7f9381e08fb43dbea72
			// secret: 0x4d5db4107d237df6a3d58ee5f70ae63d73d7658d4026f2eefd2f204c81682cb7
			eth_signer: KeyPair::from_secret_slice(
				&hex::decode("4d5db4107d237df6a3d58ee5f70ae63d73d7658d4026f2eefd2f204c81682cb7")
					.expect("secret is hardcoded, thus valid; qed"),
			).expect("secret is hardcoded, thus valid; qed"),
			eth_gas_price: 8_000_000_000u64.into(), // 8 Gwei
			eth_contract_code: hex::decode("60806040523480156200001157600080fd5b5060405162000fe538038062000fe5833981810160405260608110156200003757600080fd5b81019080805160405193929190846401000000008211156200005857600080fd5b838201915060208201858111156200006f57600080fd5b82518660018202830111640100000000821117156200008d57600080fd5b8083526020830192505050908051906020019080838360005b83811015620000c3578082015181840152602081019050620000a6565b50505050905090810190601f168015620000f15780820380516001836020036101000a031916815260200191505b5060405260200180519060200190929190805160405193929190846401000000008211156200011f57600080fd5b838201915060208201858111156200013657600080fd5b82518660018202830111640100000000821117156200015457600080fd5b8083526020830192505050908051906020019080838360005b838110156200018a5780820151818401526020810190506200016d565b50505050905090810190601f168015620001b85780820380516001836020036101000a031916815260200191505b50604052505050620001c962000454565b620001da846200034960201b60201c565b90508060000151600081905550806000015160028190555080604001516001819055506040518060e001604052806001151581526020018260200151815260200182604001518152602001826080015181526020018467ffffffffffffffff1681526020016000801b81526020016000815250600560008360000151815260200190815260200160002060008201518160000160006101000a81548160ff02191690831515021790555060208201518160010155604082015181600201556060820151816003019080519060200190620002b692919062000489565b5060808201518160040160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555060a0820151816005015560c0820151816006015590505082600360006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555081600490805190602001906200033e92919062000489565b505050505062000538565b6200035362000454565b600080600080600060608751602089016040516020810160208101602081016020810160a08588886010600019fa6200038b57600080fd5b84519c5083519b5082519a508151995080519850505050505050506000821462000420578167ffffffffffffffff81118015620003c757600080fd5b506040519080825280601f01601f191660200182016040528015620003fb5781602001600182028036833780820191505090505b50905087516020890160208301848184846011600019fa6200041c57600080fd5b5050505b6040518060a00160405280878152602001868152602001858152602001848152602001828152509650505050505050919050565b6040518060a0016040528060008019168152602001600080191681526020016000815260200160008152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f10620004cc57805160ff1916838001178555620004fd565b82800160010185558215620004fd579182015b82811115620004fc578251825591602001919060010190620004df565b5b5090506200050c919062000510565b5090565b6200053591905b808211156200053157600081600090555060010162000517565b5090565b90565b610a9d80620005486000396000f3fe608060405234801561001057600080fd5b506004361061005b5760003560e01c8063871ebe1814610061578063a98bfaad146100a7578063d96a2deb146100ed578063e7af077914610112578063fae71ae8146101cd5761005c565b5b600080fd5b61008d6004803603602081101561007757600080fd5b810190808035906020019092919050505061029c565b604051808215151515815260200191505060405180910390f35b6100d3600480360360208110156100bd57600080fd5b81019080803590602001909291905050506102c9565b604051808215151515815260200191505060405180910390f35b6100f561036c565b604051808381526020018281526020019250505060405180910390f35b6101cb6004803603602081101561012857600080fd5b810190808035906020019064010000000081111561014557600080fd5b82018360208201111561015757600080fd5b8035906020019184600183028401116401000000008311171561017957600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610398565b005b61029a600480360360608110156101e357600080fd5b8101908080359060200190929190803590602001909291908035906020019064010000000081111561021457600080fd5b82018360208201111561022657600080fd5b8035906020019184600183028401116401000000008311171561024857600080fd5b91908080601f016020809104026020016040519081016040528093929190818152602001838380828437600081840152601f19601f820116905080830192505050505050509192919290505050610627565b005b60006005600083815260200190815260200160002060000160009054906101000a900460ff169050919050565b6000806005600084815260200190815260200160002090508060000160009054906101000a900460ff16801561030457506001548160020154115b8015610317575080600601548160020154145b80156103645750600360009054906101000a900467ffffffffffffffff1667ffffffffffffffff168160040160009054906101000a900467ffffffffffffffff1667ffffffffffffffff16145b915050919050565b600080600060056000805481526020019081526020016000209050806002015460005492509250509091565b6103a06108b1565b6103a98261079f565b90506000600560008360200151815260200190815260200160002090506001826040015103816002015414610429576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401808060200182810382526026815260200180610a136026913960400191505060405180910390fd5b60008160040160009054906101000a900467ffffffffffffffff1690506000826005015490506000836003018054600181600116156101000203166002900490501461047d57836020015190506001820191505b60008360060154905060008560800151511461051a578460400151811061050c576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004018080602001828103825260198152602001807f4f7665726c617070696e67207369676e616c7320666f756e640000000000000081525060200191505060405180910390fd5b846060015185604001510190505b6040518060e001604052806001151581526020018660200151815260200186604001518152602001866080015181526020018467ffffffffffffffff16815260200183815260200182815250600560008760000151815260200190815260200160002060008201518160000160006101000a81548160ff021916908315150217905550602082015181600101556040820151816002015560608201518160030190805190602001906105cd9291906108e6565b5060808201518160040160006101000a81548167ffffffffffffffff021916908367ffffffffffffffff16021790555060a0820151816005015560c082015181600601559050508460000151600081905550505050505050565b82600560008481526020019081526020016000206002015414610695576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040180806020018281038252602f815260200180610a39602f913960400191505060405180910390fd5b6000600254905060006106a98585856108a3565b905060006005600083815260200190815260200160002090508160028190555080600201546001819055505b8282146107975760056000838152602001908152602001600020905080600101549150806006015481600201541415610792576000600560008360050154815260200190815260200160002090506001600360008282829054906101000a900467ffffffffffffffff160192506101000a81548167ffffffffffffffff021916908367ffffffffffffffff160217905550806003016004908054600181600116156101000203166002900461078b929190610966565b5050610797565b6106d5565b505050505050565b6107a76108b1565b600080600080600060608751602089016040516020810160208101602081016020810160a08588886010600019fa6107de57600080fd5b84519c5083519b5082519a508151995080519850505050505050506000821461086f578167ffffffffffffffff8111801561081857600080fd5b506040519080825280601f01601f19166020018201604052801561084b5781602001600182028036833780820191505090505b50905087516020890160208301848184846011600019fa61086b57600080fd5b5050505b6040518060a00160405280878152602001868152602001858152602001848152602001828152509650505050505050919050565b600060025490509392505050565b6040518060a0016040528060008019168152602001600080191681526020016000815260200160008152602001606081525090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061092757805160ff1916838001178555610955565b82800160010185558215610955579182015b82811115610954578251825591602001919060010190610939565b5b50905061096291906109ed565b5090565b828054600181600116156101000203166002900490600052602060002090601f016020900481019282601f1061099f57805485556109dc565b828001600101855582156109dc57600052602060002091601f016020900482015b828111156109db5782548255916001019190600101906109c0565b5b5090506109e991906109ed565b5090565b610a0f91905b80821115610a0b5760008160009055506001016109f3565b5090565b9056fe4d697373696e6720706172656e74206865616465722066726f6d207468652073746f726167654d697373696e672066696e616c69747920746172676574206865616465722066726f6d207468652073746f72616765a26469706673582212206e906d6f9a0d3370970670a70ebca5eac84698d1c6f1dc9d923a0c0fe40dfc9b64736f6c63430006060033")
				.expect("code is hardcoded, thus valid; qed"),
			sub_host: "localhost".into(),
			sub_port: 9933,
			sub_initial_authorities_set_id: None,
			sub_initial_authorities_set: None,
			sub_initial_header: None,
		}
	}
}

/// Deploy Bridge contract on Ethereum chain.
pub fn run(params: EthereumDeployContractParams) {
	let mut local_pool = futures::executor::LocalPool::new();

	let result = local_pool.run_until(async move {
		let eth_uri = format!("http://{}:{}", params.eth_host, params.eth_port);
		let eth_client = ethereum_client::client(&eth_uri);

		let sub_uri = format!("http://{}:{}", params.sub_host, params.sub_port);
		let sub_client = substrate_client::client(&sub_uri);

		let (sub_client, initial_header) = prepare_initial_header(sub_client, params.sub_initial_header).await;
		let (initial_header_hash, initial_header) = initial_header?;
		let initial_set_id = params.sub_initial_authorities_set_id.unwrap_or(0);
		let (_, initial_set) = prepare_initial_authorities_set(
			sub_client,
			initial_header_hash,
			params.sub_initial_authorities_set,
		).await;
		let initial_set = initial_set?;

		let raw_initial_header = initial_header.encode();

		log::info!(
			target: "bridge",
			"Deploying Ethereum contract.\r\n\tInitial header: {}\r\n\tInitial authorities set ID: {}\r\n\tInitial authorities set: {}",
			hex::encode(raw_initial_header),
			initial_set_id,
			initial_set,
		);

		ethereum_client::deploy_bridge_contract(
			eth_client,
			params.eth_signer,
			params.eth_chain_id,
			params.eth_gas_price,
			params.eth_contract_code,
			raw_initial_header,
			initial_set_id,
			initial_set,
		).await.1.map_err(|error| format!("Error deploying contract: {:?}", error))
	});

	if let Err(error) = result {
		log::error!(target: "bridge", "{}", error);
	}
}

/// Prepare initial header.
async fn prepare_initial_header(
	sub_client: substrate_client::Client,
	sub_initial_header: Option<Vec<u8>>,
) -> (substrate_client::Client, Result<(SubstrateHash, Vec<u8>), String>) {
	match sub_initial_header {
		Some(raw_initial_header) => {
			match SubstrateHeader::decode(&mut &raw_initial_header[..]) {
				Ok(initial_header) => (sub_client, Ok((initial_header.hash(), raw_initial_header))),
				Err(error) => (sub_client, Err(format!("Error decoding initial header: {}", error))),
			}
		},
		None => {
			let (sub_client, initial_header) = substrate_client::header_by_number(
				sub_client,
				Zero::zero(),
			).await;
			(
				sub_client,
				initial_header
					.map(|header| (header.hash(), header.encode()))
					.map_err(|error| format!("Error reading Substrate genesis header: {:?}", error))
			)
		},
	}
}

/// Prepare initial GRANDPA authorities set.
async fn prepare_initial_authorities_set(
	sub_client: substrate_client::Client,
	sub_initial_header_hash: SubstrateHash,
	sub_initial_authorities_set: Option<Vec<u8>>,
) -> (substrate_client::Client, Result<Vec<u8>, String>) {
	let (sub_client, initial_authorities_set) = match sub_initial_authorities_set {
		Some(initial_authorities_set) => (sub_client, Ok(initial_authorities_set)),
		None => substrate_client::grandpa_authorities_set(
			sub_client,
			sub_initial_header_hash,
		).await,
	};

	(
		sub_client,
		initial_authorities_set
			.map_err(|error| format!("Error reading GRANDPA authorities set: {:?}", error)),
	)
}
