version: '3'
services:
  poa-node:
    build:
      context: .
      dockerfile: ./OpenEthereum.Dockerfile
      args:
        ETHEREUM_HASH: 9838f59b6536e7482e145fa55acf07ac4e824ed0
        BRIDGE_HASH: master
    entrypoint: /home/openethereum/openethereum --chain=dev --no-persistent-txqueue --jsonrpc-apis=all --unsafe-expose
    environment:
      RUST_LOG: debug,rpc=trace
    ports:
      - "8545:8545"
      - "8546:8546"

  relay-eth2sub:
    build:
      context: .
      dockerfile: ../../Dockerfile
      args:
        BRIDGE_HASH: td-deployments
        PROJECT: ethereum-poa-relay
    #entrypoint: bash -c "set -xe; sleep 3 && curl -v http://poa-node:8545/api/health && curl -v http://bridge-node:9933/health && /home/user/ethereum-poa-relay eth-to-sub --sub-host 172.21.0.3 --eth-host 172.21.0.2"
    entrypoint: bash -c "exit 0"
    environment:
      RUST_LOG: debug,rpc=trace,bridge=trace
    depends_on:
      - poa-node
      - bridge-node
    # TODO healthcheck

  bridge-node:
    build:
      context: .
      dockerfile: ../../Dockerfile
      args:
        BRIDGE_HASH: master
        PROJECT: bridge-node
    entrypoint: /home/user/bridge-node --execution=Native --dev --unsafe-rpc-external --unsafe-ws-external
    environment:
      RUST_LOG: runtime=trace,rpc=debug,txpool=trace,basic_authorship=trace
    ports:
      - "9933:9933"
      - "9944:9944"
    healthcheck:
      test: "curl -f http://localhost:9933/health || exit 1"
      interval: 3m00s
      timeout: 10s
      retries: 3


