version: '3.5'
services:
  poa-node-arthur: &poa-node
    build:
      context: .
      dockerfile: ./OpenEthereum.Dockerfile
      args:
        ETHEREUM_HASH: 9838f59b6536e7482e145fa55acf07ac4e824ed0
        BRIDGE_HASH: master
    entrypoint:
      - /home/openethereum/openethereum
      - --config=/config/poa-node-config
      - --node-key=arthur
      - --engine-signer=0x005e714f896a8b7cede9d38688c1a81de72a58e4
    volumes:
      - ./poa-config:/config
    environment:
      RUST_LOG: rpc=trace
    ports:
      - "8545:8545"
      - "8546:8546"
      - "30303:30303"

  poa-node-bertha:
    <<: *poa-node
    entrypoint:
      - /home/openethereum/openethereum
      - --config=/config/poa-node-config
      - --node-key=bertha
      - --engine-signer=0x007594304039c2937a12220338aab821d819f5a4
    ports:
      - "8645:8545"
      - "8646:8546"
      - "31303:30303"

  poa-node-carlos:
    <<: *poa-node
    entrypoint:
      - /home/openethereum/openethereum
      - --config=/config/poa-node-config
      - --node-key=carlos
      - --engine-signer=0x004e7a39907f090e19b0b80a277e77b72b22e269
    ports:
      - "8745:8545"
      - "8746:8546"
      - "32303:30303"

  relay-eth2sub:
    build:
      context: .
      dockerfile: ../../Dockerfile
      args:
        BRIDGE_HASH: td-deployments
        PROJECT: ethereum-poa-relay
    entrypoint: /config/run-relay-eth2sub
    volumes:
      - .:/config
    environment:
      RUST_LOG: rpc=trace,bridge=trace
    depends_on:
      - poa-node-arthur
      - poa-node-bertha
      - poa-node-carlos
      - bridge-node-alice
      - bridge-node-bob

  bridge-node-alice: &bridge-node
    build:
      context: .
      dockerfile: ../../Dockerfile
      args:
        BRIDGE_HASH: 00291355117a4c5fbb2350dfb1e612ca3389168a
        PROJECT: bridge-node
    entrypoint:
      - /home/user/bridge-node
      - --execution=Native
      - --discover-local
      - --rpc-cors=all
      - --chain=local
      - --alice
      - --unsafe-rpc-external
      - --unsafe-ws-external
    environment:
      RUST_LOG: runtime=trace,rpc=debug,txpool=trace
    ports:
      - "9933:9933"
      - "9944:9944"
    healthcheck:
      test: "curl -f http://localhost:9933/health || exit 1"
      interval: 3m00s
      timeout: 10s
      retries: 3

  bridge-node-bob:
    <<: *bridge-node
    entrypoint:
      - /home/user/bridge-node
      - --execution=Native
      - --discover-local
      - --rpc-cors=all
      - --chain=local
      - --bob
      - --unsafe-rpc-external
      - --unsafe-ws-external
    ports:
      - "10033:9933"
      - "10044:9944"
