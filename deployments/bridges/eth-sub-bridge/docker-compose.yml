# This Compose file should be built using the Rialto and Eth-PoA node
# compose files. Otherwise it won't work.

version: '3.5'
services:
  # We provide an override for this particular node since this is a public facing
  # node which we use to connect from things like Polkadot JS Apps.
  rialto-node-charlie:
    environment:
      VIRTUAL_HOST: rialto.bridges.test-installations.parity.io,wss.rialto.brucke.link
      VIRTUAL_PORT: 9944
      LETSENCRYPT_HOST: rialto.bridges.test-installations.parity.io,wss.rialto.brucke.link
      LETSENCRYPT_EMAIL: admin@parity.io

  relay-eth2sub:
    image: paritytech/ethereum-poa-relay
    entrypoint: /config/relay-eth2sub-entrypoint.sh
    volumes:
      - ./scripts:/config
    environment:
      RUST_LOG: rpc=trace,bridge=trace
    ports:
      - "9616:9616"
    depends_on: &all-nodes
      - poa-node-arthur
      - poa-node-bertha
      - poa-node-carlos
      - rialto-node-alice
      - rialto-node-bob
      - rialto-node-charlie
      - rialto-node-dave
      - rialto-node-eve

  poa-exchange-tx-generator:
    image: paritytech/ethereum-poa-relay
    entrypoint: /config/poa-exchange-tx-generator-entrypoint.sh
    volumes:
      - ./scripts:/config
    environment:
      RUST_LOG: rpc=trace,bridge=trace
      EXCHANGE_GEN_MIN_AMOUNT_FINNEY: ${EXCHANGE_GEN_MIN_AMOUNT_FINNEY:-1}
      EXCHANGE_GEN_MAX_AMOUNT_FINNEY: ${EXCHANGE_GEN_MAX_AMOUNT_FINNEY:-100000}
      EXCHANGE_GEN_MAX_SUBMIT_DELAY_S: ${EXCHANGE_GEN_MAX_SUBMIT_DELAY_S:-60}
    depends_on: *all-nodes

  relay-eth-exchange-sub:
    image: paritytech/ethereum-poa-relay
    entrypoint: /config/relay-eth-exchange-sub-entrypoint.sh
    volumes:
      - ./scripts:/config
    environment:
      RUST_LOG: rpc=trace,bridge=trace
    ports:
      - "9716:9616"
    depends_on: *all-nodes

  relay-sub2eth:
    image: paritytech/ethereum-poa-relay
    entrypoint: /config/relay-sub2eth-entrypoint.sh
    volumes:
      - ./scripts:/config
    environment:
      RUST_LOG: rpc=trace,bridge=trace
    ports:
      - "9618:9616"
    depends_on: *all-nodes

  prometheus-metrics:
    image: prom/prometheus:v2.20.1
    volumes:
      - ./dashboard/prometheus/:/etc/prometheus/
    ports:
      - "9090:9090"
    depends_on: *all-nodes

  grafana-dashboard:
    image: grafana/grafana:7.1.3
    environment:
      VIRTUAL_HOST: dashboard.rialto.bridges.test-installations.parity.io,grafana.rialto.brucke.link
      VIRTUAL_PORT: 3000
      LETSENCRYPT_HOST: dashboard.rialto.bridges.test-installations.parity.io,grafana.rialto.brucke.link
      LETSENCRYPT_EMAIL: admin@parity.io
      GF_SECURITY_ADMIN_PASSWORD: ${GRAFANA_ADMIN_PASS:-admin}
      GF_SERVER_ROOT_URL: ${GRAFANA_SERVER_ROOT_URL}
      GF_SERVER_DOMAIN: ${GRAFANA_SERVER_DOMAIN}
    volumes:
      - ./dashboard/grafana/provisioning/:/etc/grafana/provisioning/
    ports:
      - "3000:3000"
    depends_on:
      - prometheus-metrics

  grafana-matrix-notifier:
    build:
      context: .
      dockerfile: ./GrafanaMatrix.Dockerfile
    volumes:
      - ./dashboard/grafana-matrix:/config
    ports:
      - "4567:4567"
    depends_on:
      - grafana-dashboard

  front-end:
    build:
      context: .
      dockerfile: ./Front-end.Dockerfile
      args:
        SUBSTRATE_PROVIDER: ${UI_SUBSTRATE_PROVIDER:-ws://localhost:9944}
        ETHEREUM_PROVIDER: ${UI_ETHEREUM_PROVIDER:-http://localhost:8545}
        EXPECTED_ETHEREUM_NETWORK_ID: ${UI_EXPECTED_ETHEREUM_NETWORK_ID:-105}
    ports:
      - "8080:80"
